# tcp正常断开连接

这个问题比较简单，分为以下几种情况：

- 调用close时，如果接受缓冲区非空，但是对端已经接受了ACK，此时调用端会发送RST报文到对端
- 调用close时，如果发送缓冲区非空，会将发送缓冲区清空以后才发送FIN报文，此时也会关闭NAGEL选项
- 调用close时，如果文件描述符是监听套接字，那么：
  - 监听套接字不对应一个连接，但是其对应连个连接队列，**未完成连接队列 SYN_RECV**以及**已完成连接队列 ESTABLISHED**，如果监听套接字已经关闭了，向其对应的未完成连接队列中的所有半连接发送RST报文
- 调用close时，发现对应fd设置了SO_LINGER选项，如果超时时间设置为0，发送RST报文

# 异常场景

- 当客户端程序因未知原因崩溃或异常退出时，操作系统会给服务端发送一条**RST**消息
- 客户端断电或网络异常，如果此时连接通道内没有任何数据交互，那么服务端是感知不到客户端掉线的，此时需要借助心跳机制来感知这种状态
- 如果客户端断电或网络异常，但是连接通道内有数据，那么服务端会在发送ACK或者等待对端的ACK时，会因为RST或者超时而关闭连接